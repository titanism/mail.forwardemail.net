<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Forward Email - IPC Isolation</title>
  </head>
  <body>
    <script>
      /**
       * Tauri Isolation Pattern – IPC Message Validator
       *
       * This script runs in a sandboxed iframe that intercepts ALL IPC messages
       * from the frontend before they reach the Tauri Core / Rust backend.
       * Messages are encrypted with AES-GCM using a key generated at app launch.
       *
       * We use this layer to:
       *   1. Log IPC messages for audit purposes
       *   2. Reject payloads that exceed size limits
       *   3. Validate known command arguments
       *
       * Note: The Tauri v2 isolation hook receives an opaque payload object.
       * Returning the payload allows the message through; returning null blocks it.
       * Command-level permissions are enforced by the Tauri capability system,
       * so the isolation hook focuses on payload-level validation.
       */

      // Maximum payload size in bytes (256 KB)
      var MAX_PAYLOAD_SIZE = 256 * 1024;

      window.__TAURI_ISOLATION_HOOK__ = function (payload) {
        try {
          // 1. Check payload size to prevent abuse
          var serialized = JSON.stringify(payload);
          if (serialized && serialized.length > MAX_PAYLOAD_SIZE) {
            console.warn('[isolation] Blocked oversized payload:', serialized.length, 'bytes');
            return null;
          }
        } catch (err) {
          console.error('[isolation] Validation error:', err);
          return null;
        }

        // Allow the message through — command-level access control is
        // enforced by the Tauri capability system (capabilities/default.json)
        return payload;
      };
    </script>
  </body>
</html>
